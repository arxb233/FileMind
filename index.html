<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <title>FileMind â€“ æ–‡ä»¶æ€ç»´å¯¼å›¾</title>

    <!-- jsTree æ ·å¼ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <!-- jQuery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- jsTree JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <!-- Markmap -->
    <script src="https://cdn.jsdelivr.net/npm/markmap-autoloader@0.18"></script>

    <style>
        html,
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            display: flex;
            font-family: "Segoe UI", Tahoma, sans-serif;
            background: white;
        }

        /* å·¦ä¾§æ–‡ä»¶æ ‘ */
        #sidebar {
            width: 280px;
            background: #fff;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            overflow: hidden;
            box-shadow: 2px 0 6px rgba(0, 0, 0, 0.05);
        }

        /* å·¦ä¾§é¡¶éƒ¨æ ‡é¢˜æ  */
        .sidebar-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(to right, #276FF5, #4D90FE);
            color: white;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px 6px 0 0;
        }

        .sidebar-header .folder-icon {
            margin-right: 8px;
            font-size: 18px;
        }

        /* æ ‘å®¹å™¨ */
        #file-tree {
            padding: 8px 12px;
            flex: 1;
            overflow-y: auto;
        }

        /* å³ä¾§ä¸»åŒºåŸŸ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* é¡¶éƒ¨ header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 24px;
            background: linear-gradient(to right, #276FF5, #4D90FE);
            color: white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            margin-left: 5px;
            flex-shrink: 0;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        /* å·¦ä¾§ä¿¡æ¯ */
        .header-left {
            flex: 1;
            font-size: 14px;
            color: #d0e0ff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ä¸­é—´æ ‡é¢˜ */
        .header-center {
            flex: 1;
            text-align: center;
        }

        .header-center h1 {
            margin: 0;
            font-size: 20px;
        }

        /* å³ä¾§ GitHub */
        .header-right {
            flex: 1;
            text-align: right;
        }

        .header-right img {
            width: 24px;
            height: 24px;
            filter: invert(1);
            vertical-align: middle;
        }

        .header-right a {
            text-decoration: none;
        }

        /* Markmap */
        .markmap {
            flex: 1;
            display: flex;
            background: #fff;
            margin: 0;
            margin-left: 5px;
            border-radius: 6px;
            box-shadow: 0 1px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        svg.markmap {
            width: 100%;
            height: 100%;
        }

        a {
            text-decoration: none;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
        }

        a[data-type="folder"] {
            color: #1a73e8;
            font-weight: bold;
        }

        a[data-type="file"] {
            color: #0c0a0a;
            font-weight: bold;
        }

        a:hover {
            background: rgba(26, 115, 232, 0.1);
        }

        /* è‡ªå®šä¹‰å³é”®èœå• */
        #context-menu {
            position: absolute;
            display: none;
            background: #c5e6fe;
            border: 1px solid #ccc;
            border-radius: 4px;
            color: black;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            min-width: 120px;
            font-size: 13px;
        }

        #context-menu div {
            padding: 6px 12px;
            cursor: pointer;
        }

        #context-menu div:hover {
            background: #1a73e8;
            color: white;
        }
    </style>
</head>

<body>

    <!-- å·¦ä¾§æ–‡ä»¶æ ‘ -->
    <div id="sidebar">
        <div class="sidebar-header">
            <span class="folder-icon">ğŸ“‚</span>
            <span class="sidebar-title">æ–‡ä»¶æµè§ˆå™¨</span>
        </div>
        <div id="file-tree"></div>
    </div>

    <!-- å³ä¾§ä¸»åŒºåŸŸ -->
    <div class="main">
        <header>
            <div class="header-left" id="header-left">
                <span id="info-text">è¯·åœ¨å·¦ä¾§æ–‡ä»¶å¤¹å³é”®èœå•ç‚¹å‡»åŠ è½½æ€ç»´å¯¼å›¾</span>
            </div>
            <div class="header-center">
                <h1>FileMind â€“ æ–‡ä»¶æ€ç»´å¯¼å›¾ - baris</h1>
            </div>
            <div class="header-right">
                <a href="https://github.com/arxb233/FileMind" target="_blank" title="GitHub">
                    <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/github.svg" alt="GitHub" />
                </a>
            </div>
        </header>
        <div class="markmap" id="markmap-tree-md">
            <span id="info-text">è¯·åœ¨å·¦ä¾§æ–‡ä»¶å¤¹å³é”®èœå•ç‚¹å‡»åŠ è½½æ€ç»´å¯¼å›¾</span>
            <script id="tree-md" type="text/template"></script>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å³é”®èœå• -->
    <div id="context-menu"></div>

    <script>
        const contextMenu = document.getElementById("context-menu");

        const menuItems = [
            { label: "åŠ è½½æ€ç»´å¯¼å›¾", action: (path) => LoadMind(path) },
            { label: "æ‰“å¼€", action: (path) => openPath(path) },
        ];

        function showContextMenu(x, y, path) {
            contextMenu.innerHTML = "";
            menuItems.forEach(item => {
                const div = document.createElement("div");
                div.textContent = item.label;
                div.onclick = () => { item.action(path); hideContextMenu(); };
                contextMenu.appendChild(div);
            });
            contextMenu.style.left = x + "px";
            contextMenu.style.top = y + "px";
            contextMenu.style.display = "block";
        }

        function hideContextMenu() {
            contextMenu.style.display = "none";
        }

        document.addEventListener("click", hideContextMenu);

        async function loadTree(path = null) {
            const url = path ? `/api/tree?path=${encodeURIComponent(path)}` : "/api/tree";
            const res = await fetch(url);
            const data = await res.json();

            const container = document.getElementById("markmap-tree-md");
            if (!container) return;

            // ç›´æ¥è¦†ç›–æ•´ä¸ªå®¹å™¨å†…å®¹ï¼Œautoloader ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“
            container.innerHTML = `
                <script type="text/template">
                    ${data.markdown.replace(/<\/script>/gi, "</scr\\ipt>")} <!-- é˜²æ­¢è„šæœ¬æ³¨å…¥ -->
                <\/script>
            `;

            // autoloader å·²ç»ç›‘å¬ DOM å˜åŒ–ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨
            // ä½†ä¿é™©èµ·è§å¯ä»¥æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡
            window.markmap?.autoLoader?.renderAll?.();
        }


        // åŠ è½½ç›®å½•ç»Ÿè®¡
        async function loadInfo(path = null) {
            const url = path ? `/api/info?path=${encodeURIComponent(path)}` : "/api/info";
            const res = await fetch(url);
            const info = await res.json();
            document.getElementById("info-text").textContent =
                `è·¯å¾„: ${info.path} | æ–‡ä»¶å¤¹: ${info.folders} | æ–‡ä»¶: ${info.files} | ç”Ÿæˆæ—¶é—´: ${info.generated}`;
        }

        async function loadDrives() {
            const res = await fetch("/api/drives");
            const drives = await res.json();

            const treeData = drives.map(drive => ({
                id: drive,
                text: drive,
                children: true
            }));

            $('#file-tree').jstree({
                'core': {
                    'data': function (node, cb) {
                        if (node.id === "#") {
                            cb(treeData);
                        } else {
                            fetch(`/api/list?path=${encodeURIComponent(node.id)}`)
                                .then(r => r.json())
                                .then(data => {
                                    const children = [];

                                    data.folders.forEach(f => {
                                        const folderPath = node.id.endsWith("\\") ? node.id + f : node.id + "\\" + f;
                                        children.push({ id: folderPath, text: f, children: true });
                                    });

                                    data.files.forEach(f => {
                                        const filePath = node.id.endsWith("\\") ? node.id + f : node.id + "\\" + f;
                                        children.push({ id: filePath, text: f, children: false, icon: "jstree-file" });
                                    });

                                    cb(children);
                                })
                                .catch(err => { console.error("åŠ è½½å­èŠ‚ç‚¹å¤±è´¥:", err); cb([]); });
                        }
                    },
                    'check_callback': true,
                    'themes': { 'dots': true, 'icons': true }
                }
            });

            // jsTree å³é”®èœå•ç»‘å®š
            $('#file-tree').on("contextmenu", ".jstree-anchor", function (e) {
                e.preventDefault();
                const node = $.jstree.reference(this).get_node(this);
                showContextMenu(e.pageX, e.pageY, node.id);
            });
        }

        // ç‚¹å‡»æ–‡ä»¶/æ–‡ä»¶å¤¹æ‰“å¼€
        function openPath(path) {
            fetch('/api/open', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path })
            });
        }
        function LoadMind(path) {
            loadTree(path);
            loadInfo(path);
        }

        document.addEventListener('click', (e) => {
            const target = e.target;
            const { path, type } = target.dataset || {};

            if (target.tagName === 'A' && path) {
                e.preventDefault();
                fetch('/api/open', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path, type })
                });
            }
        });

        async function init() {
            await loadDrives();
            await loadTree();
        }

        init();
    </script>
</body>

</html>